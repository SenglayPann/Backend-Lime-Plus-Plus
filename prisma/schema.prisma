// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ORGANIZATION_OWNER
  ADMIN
  DEPARTMENT_MANAGER
  PROJECT_MANAGER
  PROJECT_MEMBER
}

enum Platform {
  GITHUB
  GITLAB
  BITBUCKET
}

enum ProjectStatus {
  ACTIVE
  LOCKED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskDifficulty {
  LOW
  MEDIUM
  HIGH
}

enum PrStatus {
  OPEN
  MERGED
  CLOSED
}

enum ReviewState {
  APPROVED
  COMMENTED
  CHANGES_REQUESTED
}

enum AuditAction {
  SCORE_OVERRIDE
  TASK_REASSIGN
  PROJECT_LOCK
  ROLE_CHANGE
}

// Models
model Organization {
  id          String       @id @default(uuid())
  name        String
  licensePlan String       @map("license_plan")
  createdAt   DateTime     @default(now()) @map("created_at")
  departments Department[]
  userRoles   UserRole[]

  @@map("organizations")
}

model Department {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  createdAt      DateTime     @default(now()) @map("created_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects       Project[]
  userRoles      UserRole[]

  @@map("departments")
}

model User {
  id                  String              @id @default(uuid())
  githubUserId        String              @unique @map("github_user_id")
  email               String?
  name                String?
  avatarUrl           String?             @map("avatar_url")
  createdAt           DateTime            @default(now()) @map("created_at")
  userRoles           UserRole[]
  projectMembers      ProjectMember[]
  assignedTasks       Task[]
  authoredPRs         PullRequest[]
  prReviews           PrReview[]
  contributionEvents  ContributionEvent[]
  contributionScores  ContributionScore[]
  scoreOverrides      ScoreOverride[]     @relation("OverriddenUser")
  overridesPerformed  ScoreOverride[]     @relation("OverriddenBy")
  auditLogs           AuditLog[]

  @@map("users")
}

model UserRole {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  role           Role
  organizationId String?       @map("organization_id")
  departmentId   String?       @map("department_id")
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department?   @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@map("user_roles")
}

model Project {
  id                 String              @id @default(uuid())
  departmentId       String              @map("department_id")
  name               String
  platform           Platform            @default(GITHUB)
  repository         String
  externalProjectId  String?             @map("external_project_id")
  status             ProjectStatus       @default(ACTIVE)
  evalStart          DateTime?           @map("eval_start") @db.Date
  evalEnd            DateTime?           @map("eval_end") @db.Date
  lockedAt           DateTime?           @map("locked_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  department         Department          @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  members            ProjectMember[]
  tasks              Task[]
  pullRequests       PullRequest[]
  contributionEvents ContributionEvent[]
  contributionScores ContributionScore[]
  scoreOverrides     ScoreOverride[]
  auditLogs          AuditLog[]

  @@map("projects")
}

model ProjectMember {
  id        String  @id @default(uuid())
  projectId String  @map("project_id")
  userId    String  @map("user_id")
  role      Role    @default(PROJECT_MEMBER)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Task {
  id             String         @id @default(uuid())
  projectId      String         @map("project_id")
  externalTaskId String         @map("external_task_id")
  title          String
  description    String?
  assigneeId     String         @map("assignee_id")
  status         TaskStatus     @default(TODO)
  difficulty     TaskDifficulty @default(MEDIUM)
  dueDate        DateTime?      @map("due_date") @db.Date
  createdAt      DateTime       @default(now()) @map("created_at")
  completedAt    DateTime?      @map("completed_at")
  project        Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee       User           @relation(fields: [assigneeId], references: [id], onDelete: Restrict)
  pullRequests   PullRequest[]

  @@unique([projectId, externalTaskId])
  @@map("tasks")
}

model PullRequest {
  id           String     @id @default(uuid())
  projectId    String     @map("project_id")
  platform     Platform   @default(GITHUB)
  externalPrId String     @map("external_pr_id")
  taskId       String?    @map("task_id")
  authorId     String     @map("author_id")
  title        String
  url          String?
  status       PrStatus   @default(OPEN)
  mergedAt     DateTime?  @map("merged_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task         Task?      @relation(fields: [taskId], references: [id], onDelete: SetNull)
  author       User       @relation(fields: [authorId], references: [id], onDelete: Restrict)
  reviews      PrReview[]

  @@unique([projectId, externalPrId])
  @@map("pull_requests")
}

model PrReview {
  id            String      @id @default(uuid())
  pullRequestId String      @map("pull_request_id")
  reviewerId    String      @map("reviewer_id")
  state         ReviewState
  body          String?
  createdAt     DateTime    @default(now()) @map("created_at")
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  reviewer      User        @relation(fields: [reviewerId], references: [id], onDelete: Restrict)

  @@map("pr_reviews")
}

model ContributionEvent {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  userId      String   @map("user_id")
  type        String
  referenceId String   @map("reference_id")
  score       Int
  createdAt   DateTime @default(now()) @map("created_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("contribution_events")
}

model ContributionScore {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  userId     String   @map("user_id")
  totalScore Int      @default(0) @map("total_score")
  breakdown  Json     @default("{}")
  updatedAt  DateTime @updatedAt @map("updated_at")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@unique([projectId, userId])
  @@map("contribution_scores")
}

model ScoreOverride {
  id           String   @id @default(uuid())
  projectId    String   @map("project_id")
  userId       String   @map("user_id")
  delta        Int
  reason       String
  overriddenBy String   @map("overridden_by")
  createdAt    DateTime @default(now()) @map("created_at")
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Restrict, name: "OverriddenUser")
  overrider    User     @relation(fields: [overriddenBy], references: [id], onDelete: Restrict, name: "OverriddenBy")

  @@map("score_overrides")
}

model AuditLog {
  id        String      @id @default(uuid())
  action    AuditAction
  actorId   String      @map("actor_id")
  projectId String?     @map("project_id")
  metadata  Json        @default("{}")
  createdAt DateTime    @default(now()) @map("created_at")
  actor     User        @relation(fields: [actorId], references: [id], onDelete: Restrict)
  project   Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model WebhookDelivery {
  id          String    @id @default(uuid())
  platform    Platform
  deliveryId  String    @unique @map("delivery_id")
  eventType   String    @map("event_type")
  payload     Json
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("webhook_deliveries")
}
